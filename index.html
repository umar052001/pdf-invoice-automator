<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Automation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .glass-panel { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .form-input:focus { outline: none; box-shadow: 0 0 0 2px #3b82f6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .log-entry { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex flex-col p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15h6"/></svg>
                <h1 class="text-2xl font-bold text-white">PDF Invoice Automator</h1>
            </div>
            <div id="status-indicator" class="flex items-center space-x-2">
                <span class="text-sm text-gray-400">Backend Status:</span>
                <div id="status-dot" class="w-3 h-3 rounded-full bg-green-500"></div>
                <span id="status-text" class="text-sm font-semibold text-green-400">Online</span>
            </div>
        </header>
        <main class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-panel rounded-xl p-6 flex flex-col space-y-6">
                <h2 class="text-lg font-semibold text-white border-b border-gray-700 pb-3">Controls & Configuration</h2>
                <div>
                    <label for="folderPath" class="block mb-2 text-sm font-medium text-gray-400">Folder to Watch</label>
                    <div class="flex">
                        <input type="text" id="folderPath" placeholder="Click 'Browse' to select a folder" readonly class="form-input w-full bg-gray-900 border border-gray-700 rounded-l-md px-3 py-2 focus:border-blue-500 transition cursor-pointer">
                        <button id="browseBtn" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold px-4 rounded-r-md transition">Browse</button>
                    </div>
                </div>
                <div>
                    <label for="googleSheetUrl" class="block mb-2 text-sm font-medium text-gray-400">Output Sink (Google Sheet URL)</label>
                    <input type="text" id="googleSheetUrl" placeholder="Paste your Google Sheet URL here..." class="form-input w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 focus:border-blue-500 transition">
                </div>
                <div class="flex items-center space-x-4 pt-4">
                    <button id="startBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-300 transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <span>Start Watching</span>
                    </button>
                    <button id="stopBtn" disabled class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-300 transform hover:scale-105 disabled:bg-red-800 disabled:text-gray-500 disabled:cursor-not-allowed disabled:scale-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        <span>Stop Watching</span>
                    </button>
                </div>
            </div>
            <div class="glass-panel rounded-xl p-6 flex flex-col">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-white border-b border-gray-700 pb-3 mb-4">Dashboard</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-900/50 p-4 rounded-lg"><p class="text-sm text-blue-400 font-semibold">Files Processed</p><p id="filesProcessed" class="text-3xl font-bold text-white">0</p></div>
                        <div class="bg-gray-900/50 p-4 rounded-lg"><p class="text-sm text-red-400 font-semibold">Errors</p><p id="errorCount" class="text-3xl font-bold text-white">0</p></div>
                        <div class="bg-gray-900/50 p-4 rounded-lg col-span-2 sm:col-span-1"><p class="text-sm text-green-400 font-semibold">Uptime</p><p id="uptime" class="text-3xl font-bold text-white">00:00:00</p></div>
                    </div>
                </div>
                <div class="flex-grow flex flex-col min-h-0">
                    <h2 class="text-lg font-semibold text-white border-b border-gray-700 pb-3 mb-4">Live Activity Log</h2>
                    <div id="logContainer" class="flex-grow bg-gray-900/50 rounded-lg p-4 overflow-y-auto"><p class="text-gray-500 italic">Waiting for activity...</p></div>
                </div>
            </div>
        </main>
    </div>
    <div id="message-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300"><p id="message-text"></p></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const port = await window.electron.getFastApiPort();
            const FASTAPI_URL = `http://127.0.0.1:${port}`;
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const folderPathInput = document.getElementById('folderPath');
            const browseBtn = document.getElementById('browseBtn');
            const googleSheetUrlInput = document.getElementById('googleSheetUrl'); // <-- ADDED
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const logContainer = document.getElementById('logContainer');
            const filesProcessedEl = document.getElementById('filesProcessed');
            const errorCountEl = document.getElementById('errorCount');
            const uptimeEl = document.getElementById('uptime');

            let isWatching = false;
            let uptimeInterval;
            let statusInterval;
            let startTime;

            const showMessage = (message, type = 'error') => {
                messageText.textContent = message;
                messageBox.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                messageBox.classList.remove('translate-x-full');
                setTimeout(() => { messageBox.classList.add('translate-x-full'); }, 3000);
            };

            const addLogMessage = (log) => {
                if (logContainer.querySelector('.italic')) logContainer.innerHTML = '';
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry mb-2 flex items-start text-sm';
                const iconMap = {
                    INFO: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 mr-2 mt-0.5 text-blue-400"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
                    SUCCESS: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 mr-2 mt-0.5 text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                    ERROR: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 mr-2 mt-0.5 text-red-400"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
                };
                logEntry.innerHTML = `${iconMap[log.level] || iconMap['INFO']}<div><span class="font-mono text-xs text-gray-500">${log.timestamp}</span><p class="leading-tight">${log.message}</p></div>`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            };

            const updateDashboard = (stats) => {
                filesProcessedEl.textContent = stats.files_processed;
                errorCountEl.textContent = stats.errors;
            };

            const setUiState = (watching) => {
                isWatching = watching;
                startBtn.disabled = watching;
                stopBtn.disabled = !watching;
                browseBtn.disabled = watching;
                folderPathInput.disabled = watching;
                googleSheetUrlInput.disabled = watching; // <-- ADDED
                folderPathInput.classList.toggle('cursor-pointer', !watching);
                folderPathInput.classList.toggle('cursor-not-allowed', watching);

                if (watching) {
                    startTime = Date.now();
                    updateUptime();
                    uptimeInterval = setInterval(updateUptime, 1000);
                    statusInterval = setInterval(fetchStatus, 3000);
                } else {
                    clearInterval(uptimeInterval);
                    clearInterval(statusInterval);
                }
            };

            const updateUptime = () => {
                const now = Date.now();
                const diff = Math.floor((now - startTime) / 1000);
                const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                const s = String(diff % 60).padStart(2, '0');
                uptimeEl.textContent = `${h}:${m}:${s}`;
            };

            const fetchStatus = async () => {
                try {
                    const response = await fetch(`${FASTAPI_URL}/status`);
                    if (!response.ok) throw new Error('Failed to fetch status');
                    const data = await response.json();
                    updateDashboard(data.stats);
                    data.logs.forEach(addLogMessage);
                    if (isWatching !== data.is_watching) setUiState(data.is_watching);
                } catch (error) {
                    console.error("Failed to fetch status:", error);
                    addLogMessage({ timestamp: new Date().toLocaleTimeString(), level: 'ERROR', message: 'Could not fetch status from backend.' });
                }
            };

            browseBtn.addEventListener('click', async () => {
                const selectedPath = await window.electron.openDialog();
                if (selectedPath) {
                    folderPathInput.value = selectedPath;
                }
            });
            folderPathInput.addEventListener('click', () => browseBtn.click());

            startBtn.addEventListener('click', async () => {
                const folderPath = folderPathInput.value;
                const sheetUrl = googleSheetUrlInput.value; // <-- ADDED

                if (!folderPath) {
                    showMessage("Please select a folder to watch.");
                    return;
                }
                if (!sheetUrl) { // <-- ADDED
                    showMessage("Please provide a Google Sheet URL.");
                    return;
                }
                addLogMessage({ timestamp: new Date().toLocaleTimeString(), level: 'INFO', message: `Starting to watch folder: ${folderPath}` });
                try {
                    const response = await fetch(`${FASTAPI_URL}/start-watching`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            folder_path: folderPath,
                            sheet_url: sheetUrl // <-- ADDED
                        })
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Failed to start watcher');
                    }
                    setUiState(true);
                } catch(error) {
                    showMessage(error.message);
                    addLogMessage({ timestamp: new Date().toLocaleTimeString(), level: 'ERROR', message: `Error starting watcher: ${error.message}` });
                }
            });

            stopBtn.addEventListener('click', async () => {
                addLogMessage({ timestamp: new Date().toLocaleTimeString(), level: 'INFO', message: 'Stopping watcher...' });
                try {
                    const response = await fetch(`${FASTAPI_URL}/stop-watching`, { method: 'POST' });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Failed to stop watcher');
                    }
                    setUiState(false);
                    uptimeEl.textContent = "00:00:00";
                } catch(error) {
                    showMessage(error.message);
                    addLogMessage({ timestamp: new Date().toLocaleTimeString(), level: 'ERROR', message: `Error stopping watcher: ${error.message}` });
                }
            });
        });
    </script>
</body>
</html>

